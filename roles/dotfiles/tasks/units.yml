---
- name: Process systemd user units for niri
  tags: [extra, dotfiles, dotfiles_units]
  block:
    - name: Check if 'niri' exists
      block:
        - name: Check if niri exists in system path
          ansible.builtin.command: which niri
          register: dotfiles_niri_exists
          failed_when: false
          changed_when: false

    - name: Copy niri-specific units to user directory
      when: dotfiles_niri_exists.rc == 0
      block:
        - name: Ensure systemd user config directory exists
          ansible.builtin.file:
            path: "{{ home_dir }}/.config/systemd/user"
            state: directory
            mode: "0755"
            owner: "{{ ansible_user_id | default(omit) }}"
            group: "{{ ansible_user_gid | default(omit) }}"

        - name: Check if niri units directory exists
          ansible.builtin.stat:
            path: "{{ role_path }}/files/niri-units/"
          register: dotfiles_niri_units_dir

        - name: Find systemd user unit files for niri
          ansible.builtin.find:
            paths: "{{ role_path }}/files/niri-units/"
            recurse: false
            file_type: file
            use_regex: false
          register: dotfiles_systemd_unit_files
          when: dotfiles_niri_units_dir.stat.exists
          ignore_errors: true

        - name: Copy systemd user unit files for niri
          ansible.builtin.copy:
            src: "{{ item.path }}"
            dest: "{{ home_dir }}/.config/systemd/user/{{ item.path | basename }}"
            mode: "0644"
            owner: "{{ ansible_user_id | default(omit) }}"
            group: "{{ ansible_user_gid | default(omit) }}"
            backup: true
          loop: "{{ dotfiles_systemd_unit_files.files }}"
          when:
            - dotfiles_niri_units_dir.stat.exists
            - dotfiles_systemd_unit_files.files is defined
            - dotfiles_systemd_unit_files.files | length > 0
          notify: reload_user_systemd
          register: dotfiles_copy_result
