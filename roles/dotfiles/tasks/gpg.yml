- name: GPG and SSH key install and setup
  tags: [extra, dotfiles, dotfiles_gpg]
  block:
    - name: Load GPG secrets from vault
      ansible.builtin.include_vars:
        file: "{{ vault_file }}"
        name: gpg_secrets
      no_log: true

    - name: Ensure GPG directory exists
      ansible.builtin.file:
        path: "{{ home_dir }}/.gnupg"
        state: directory
        mode: "0700"

    - name: Get fingerprint of public key file
      ansible.builtin.command: >
        gpg --with-fingerprint --show-keys "{{ gnupg_key_dir }}/public-key.asc"
      register: public_key_info
      changed_when: false

    - name: Extract public key fingerprint
      ansible.builtin.set_fact:
        public_key_fingerprint: "{{ (public_key_info.stdout | regex_search('(?<=Key fingerprint = ).*')) | replace(' ', '') }}"

    - name: Check if public key is already imported
      ansible.builtin.command: >
        gpg --list-keys "{{ public_key_fingerprint }}"
      register: check_public_key
      ignore_errors: true
      changed_when: false

    - name: Import public key (if not present)
      ansible.builtin.command: >
        gpg --import "{{ gnupg_key_dir }}/public-key.asc"
      when: check_public_key.rc != 0
      register: import_public
      changed_when: "'imported' in import_public.stdout"
      ignore_errors: true

    - name: Check if private key is already imported
      ansible.builtin.command: >
        gpg --list-secret-keys "{{ public_key_fingerprint }}"
      register: check_private_key
      ignore_errors: true
      changed_when: false

    - name: Import private key with passphrase (if not present)
      ansible.builtin.command: >
        gpg --batch --pinentry-mode loopback
        --passphrase-fd 0 --import
        "{{ gnupg_key_dir }}/private-key.asc"
      args:
        stdin: "{{ gpg_secrets.gpg_passphrase }}"
      when: check_private_key.rc != 0
      register: import_private
      changed_when: "'imported' in import_private.stdout"
      no_log: true
      ignore_errors: true

    - name: Verify key imports
      ansible.builtin.assert:
        that:
          - check_public_key.rc == 0 or import_public is not skipped
          - check_private_key.rc == 0 or import_private is not skipped
        success_msg: "GPG keys imported or already present"
        fail_msg: "Failed to import one or more GPG keys"

    # Rest of your tasks...
