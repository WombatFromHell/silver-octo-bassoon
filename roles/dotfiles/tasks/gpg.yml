---
- name: GPG and SSH key install and setup
  tags: [extra, dotfiles, dotfiles_gpg]
  block:
    - name: Load GPG secrets from vault
      ansible.builtin.include_vars:
        file: "{{ vault_file }}"
        name: dotfiles_secrets
      no_log: true

    - name: Ensure GPG directory exists
      ansible.builtin.file:
        path: "{{ home_dir }}/.gnupg"
        state: directory
        mode: "0700"

    - name: Get fingerprint of public key file
      ansible.builtin.command: >
        gpg --show-keys "{{ gnupg_key_dir }}/public-key.asc"
      register: dotfiles_public_key_info
      changed_when: false

    - name: Extract fingerprint when 'Key fingerprint =' is present
      ansible.builtin.set_fact:
        dotfiles_public_key_fingerprint: "{{ dotfiles_public_key_info.stdout | regex_search('Key fingerprint\\s*=\\s*([0-9A-F\\s]+)', '\\1') | trim }}"
      when: "'Key fingerprint' in dotfiles_public_key_info.stdout"

    - name: Extract fingerprint from second line when not present in output
      ansible.builtin.set_fact:
        dotfiles_public_key_fingerprint: "{{ dotfiles_public_key_info.stdout_lines[1] | trim }}"
      when:
        - dotfiles_public_key_info.stdout_lines | length > 0
        - dotfiles_public_key_fingerprint is not defined

    - name: Check if public key is already imported
      when: dotfiles_public_key_fingerprint is defined
      ansible.builtin.command: >
        gpg --list-keys "{{ dotfiles_public_key_fingerprint }}"
      register: dotfiles_check_public_key
      failed_when: dotfiles_check_public_key.rc not in [0, 2]
      changed_when: false

    - name: Import public key (if not present)
      ansible.builtin.command: >
        gpg --import "{{ gnupg_key_dir }}/public-key.asc"
      when:
        - dotfiles_public_key_fingerprint is defined
        - dotfiles_check_public_key is defined
        - dotfiles_check_public_key.rc != 0
      register: dotfiles_import_public
      changed_when: "'imported' in dotfiles_import_public.stdout"

    - name: Check if private key is already imported
      when: dotfiles_public_key_fingerprint is defined
      ansible.builtin.command: >
        gpg --list-secret-keys "{{ dotfiles_public_key_fingerprint }}"
      register: dotfiles_check_private_key
      failed_when: dotfiles_check_private_key.rc not in [0, 2]
      changed_when: false

    - name: Import private key with passphrase (if not present)
      ansible.builtin.command: >
        gpg --batch --pinentry-mode loopback
        --passphrase-fd 0 --import
        "{{ gnupg_key_dir }}/private-key.asc"
      args:
        stdin: "{{ dotfiles_secrets.gpg_passphrase }}"
      when:
        - dotfiles_public_key_fingerprint is defined
        - dotfiles_check_private_key is defined
        - dotfiles_check_private_key.rc != 0
      register: dotfiles_import_private
      changed_when: "'imported' in dotfiles_import_private.stdout"
      no_log: true

    - name: Ensure SSH directory exists with correct permissions
      ansible.builtin.file:
        path: "{{ home_dir }}/.ssh"
        state: directory
        mode: "0700"

    - name: Copy SSH keys to user's .ssh directory
      ansible.builtin.copy:
        src: "{{ ssh_key_dir }}/{{ ssh_item.key }}"
        dest: "{{ home_dir }}/.ssh/{{ ssh_item.key }}"
        owner: "{{ ansible_facts.user_id }}"
        group: "{{ ansible_facts.user_gid }}"
        mode: "{{ ssh_item.mode }}"
      loop:
        - { key: "id_rsa", mode: "0600" }
        - { key: "id_rsa.pub", mode: "0644" }
        - { key: "config", mode: "0600" }
      loop_control:
        loop_var: ssh_item
        label: "{{ ssh_item.key }}"

    - name: Manage SSH known_hosts file
      block:
        - name: Ensure known_hosts file exists with correct permissions
          ansible.builtin.file:
            path: "{{ home_dir }}/.ssh/known_hosts"
            state: touch # 'touch' creates the file if it's missing, or updates its timestamp if it exists.
            mode: "0600"
            owner: "{{ ansible_facts.user_id }}"
            group: "{{ ansible_facts.user_id }}"
          become_user: "{{ ansible_facts.user_id }}"
          become: true

        - name: Check if host keys already exist
          ansible.builtin.command: ssh-keygen -F {{ item.name | quote }}
          register: dotfiles_host_key_check_results
          failed_when: false
          changed_when: false
          become_user: "{{ ansible_facts.user_id }}"
          become: true
          loop:
            - name: github.com
              key_scan_command: "ssh-keyscan -t rsa,ed25519 github.com"
            - name: "[192.168.1.153]:2222"
              key_scan_command: "ssh-keyscan -t rsa,ed25519,ecdsa-sha2-nistp256 -p 2222 192.168.1.153"
          run_once: true

        - name: Add missing hosts to known_hosts
          ansible.builtin.known_hosts:
            name: "{{ item.item.name }}"
            key: "{{ lookup('pipe', item.item.key_scan_command) }}"
            path: "{{ home_dir }}/.ssh/known_hosts"
            state: present
            # 'create' and 'mode' have been removed as they are not supported here
          become_user: "{{ ansible_facts.user_id }}"
          become: true
          loop: "{{ dotfiles_host_key_check_results.results }}"
          when: item.rc != 0
          run_once: true
