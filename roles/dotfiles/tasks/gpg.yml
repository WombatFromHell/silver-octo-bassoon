- name: GPG and SSH key install and setup
  tags: [extra, dotfiles, dotfiles_gpg]
  block:
    - name: Load GPG secrets from vault
      ansible.builtin.include_vars:
        file: "{{ vault_file }}"
        name: gpg_secrets
      no_log: true

    - name: Ensure GPG directory exists
      ansible.builtin.file:
        path: "{{ home_dir }}/.gnupg"
        state: directory
        mode: "0700"

    - name: Get fingerprint of public key file
      ansible.builtin.command: >
        gpg --show-keys "{{ gnupg_key_dir }}/public-key.asc"
      register: public_key_info
      changed_when: false

    - name: Extract fingerprint when 'Key fingerprint =' is present
      ansible.builtin.set_fact:
        public_key_fingerprint: "{{ public_key_info.stdout | regex_search('Key fingerprint\\s*=\\s*([0-9A-F\\s]+)', '\\1') | trim }}"
      when: "'Key fingerprint' in public_key_info.stdout"

    - name: Extract fingerprint from second line when not present in output
      ansible.builtin.set_fact:
        public_key_fingerprint: "{{ public_key_info.stdout_lines[1] | trim }}"
      when:
        - public_key_info.stdout_lines | length > 0
        - public_key_fingerprint is not defined

    - name: Check if public key is already imported
      when: public_key_fingerprint is defined
      ansible.builtin.command: >
        gpg --list-keys "{{ public_key_fingerprint }}"
      register: check_public_key
      failed_when: check_public_key.rc not in [0, 2]
      changed_when: false

    - name: Import public key (if not present)
      ansible.builtin.command: >
        gpg --import "{{ gnupg_key_dir }}/public-key.asc"
      when:
        - public_key_fingerprint is defined
        - check_public_key is defined
        - check_public_key.rc != 0
      register: import_public
      changed_when: "'imported' in import_public.stdout"

    - name: Check if private key is already imported
      when: public_key_fingerprint is defined
      ansible.builtin.command: >
        gpg --list-secret-keys "{{ public_key_fingerprint }}"
      register: check_private_key
      failed_when: check_private_key.rc not in [0, 2]
      changed_when: false

    - name: Import private key with passphrase (if not present)
      ansible.builtin.command: >
        gpg --batch --pinentry-mode loopback
        --passphrase-fd 0 --import
        "{{ gnupg_key_dir }}/private-key.asc"
      args:
        stdin: "{{ gpg_secrets.gpg_passphrase }}"
      when:
        - public_key_fingerprint is defined
        - check_private_key is defined
        - check_private_key.rc != 0
      register: import_private
      changed_when: "'imported' in import_private.stdout"
      no_log: true

    - name: Ensure SSH directory exists with correct permissions
      ansible.builtin.file:
        path: "{{ home_dir }}/.ssh"
        state: directory
        mode: "0700"

    - name: Copy SSH keys to user's .ssh directory
      ansible.builtin.copy:
        src: "{{ ssh_key_dir }}/{{ ssh_item.key }}"
        dest: "{{ home_dir }}/.ssh/{{ ssh_item.key }}"
        owner: "{{ ansible_facts.user_id }}"
        group: "{{ ansible_facts.user_gid }}"
        mode: "{{ ssh_item.mode }}"
      loop:
        - { key: "id_rsa", mode: "0600" }
        - { key: "id_rsa.pub", mode: "0644" }
      loop_control:
        loop_var: ssh_item
        label: "{{ ssh_item.key }}"

    - name: Ensure known_hosts file exists with correct permissions for user
      ansible.builtin.file:
        path: "{{ home_dir }}/.ssh/known_hosts"
        state: touch
        owner: "{{ ansible_facts.user_id }}"
        group: "{{ ansible_facts.user_gid }}"
        mode: '0644'
      become_user: "{{ ansible_facts.user_id }}"
      become: yes

    - name: Add GitHub.com to known_hosts for user
      ansible.builtin.known_hosts:
        path: "{{ home_dir }}/.ssh/known_hosts"
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan -t rsa,ed25519 github.com 2>/dev/null || ssh-keyscan -t rsa github.com 2>/dev/null || echo \"# Manually add github.com key later\"') }}" # Fetch the key
        state: present
      become_user: "{{ ansible_facts.user_id }}"
      become: yes
