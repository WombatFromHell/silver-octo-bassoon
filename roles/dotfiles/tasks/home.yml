---
- name: Home dotfiles processing
  tags: [extra, dotfiles, dotfiles_home]
  vars:
    force_tuckr_overwrite: true
  block:
    - name: Verify tuckr is installed
      ansible.builtin.command: tuckr --version
      register: dotfiles_tuckr_check
      ignore_errors: true
      changed_when: false

    - name: Fail if tuckr not available
      ansible.builtin.fail:
        msg: "tuckr is required but not found in PATH"
      when: dotfiles_tuckr_check.rc != 0

    - name: Get list of files in Configs/home directory
      ansible.builtin.find:
        path: "{{ dotfiles_root }}/Configs/home"
        recurse: true
        file_type: any
      register: dotfiles_config_files

    - name: Process home directory with tuckr (forced mode)
      tuckr_manage:
        name: "home"
        state: present
        force: "{{ force_tuckr_overwrite | default(false) }}"
      when: dotfiles_config_files.files | length > 0
      register: dotfiles_tuckr_result
      retries: 2
      delay: 1
      until: dotfiles_tuckr_result is not failed

    - name: Display tuckr conflicts if any
      ansible.builtin.debug:
        var: dotfiles_tuckr_result
      when:
        - debug_mode | default(false) | bool
        - dotfiles_tuckr_result is defined

    - name: Check for an existing 'chromium-flags.conf'
      ansible.builtin.stat:
        path: "{{ home_realpath }}/.config/chromium-flags.conf"
      register: dotfiles_chromium_flags_check

    - name: Copy link target of 'chromium-flags.conf' if it's a link
      when: dotfiles_chromium_flags_check.stat.islnk is defined and dotfiles_chromium_flags_check.stat.islnk
      ansible.builtin.file:
        src: "{{ dotfiles_chromium_flags_check.stat.lnk_source }}"
        dest: "{{ home_realpath }}/.config/brave-flags.conf"
        state: link
        force: true

    - name: Copy chromium-flags.conf if it's not a link
      when:
        - dotfiles_chromium_flags_check.stat.exists and not (dotfiles_chromium_flags_check.stat.islnk is defined and dotfiles_chromium_flags_check.stat.islnk)
      ansible.builtin.command: |
        cp -f "{{ home_realpath }}/.config/chromium-flags.conf" "{{ home_realpath }}/.config/brave-flags.conf"
      args:
        creates: "{{ home_realpath }}/.config/brave-flags.conf"
