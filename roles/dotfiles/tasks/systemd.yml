---
- name: Systemd user units processing
  tags: [extra, dotfiles, dotfiles_systemd]
  block:
    - name: Check for systemd configs in dotfiles
      ansible.builtin.set_fact:
        dotfiles_systemd_user_dir: "{{ home_dir }}/.config/systemd/user"
        dotfiles_systemd_service_files: "{{ lookup('fileglob', dotfiles_root + '/Configs/systemd/.config/systemd/user/*.service', wantlist=true) }}"
        dotfiles_systemd_timer_files: "{{ lookup('fileglob', dotfiles_root + '/Configs/systemd/.config/systemd/user/*.timer', wantlist=true) }}"

    - name: Determine if systemd configs exist
      ansible.builtin.set_fact:
        dotfiles_has_systemd: "{{ (dotfiles_systemd_service_files | length > 0) or (dotfiles_systemd_timer_files | length > 0) }}"

    - name: Process systemd unit files
      when: dotfiles_has_systemd
      block:
        - name: Ensure systemd user directory exists
          ansible.builtin.file:
            path: "{{ dotfiles_systemd_user_dir }}"
            state: directory
            mode: "0755"

        - name: Find all systemd unit files in dotfiles
          ansible.builtin.find:
            path: "{{ dotfiles_root }}/Configs/systemd/.config/systemd/user"
            patterns: "*.service,*.timer"
            recurse: true
          register: dotfiles_systemd_dotfiles

        - name: Sync systemd unit files
          ansible.builtin.file:
            path: "{{ dotfiles_systemd_user_dir }}/{{ item.path | regex_replace('^.*/user/?', '') }}"
            src: "{{ item.path }}"
            state: link
            force: true
          loop: "{{ dotfiles_systemd_dotfiles.files }}"
          loop_control:
            label: "{{ item.path | basename }}"
          notify: reload_user_systemd
