---
- name: Setup BTRFS on grub/rEFInd
  become: true
  tags: [extra, btrfs]
  when:
    - ansible_facts['distribution'] == "Archlinux"
    - enable_btrfs_snapper | default(false)
  vars:
    # User-configurable variables
    btrfs_mount: "/mnt/btrfs"
    use_aur_helper: true
    aur_helper: "yay"
    aur_flags: "-Sy --needed --noconfirm"
    compress_algorithm: "zstd:3"
    commit_interval: 120
    grub_cfg_path: "/boot/grub/grub.cfg"
    btrfs_grub_wrapper_path: "/usr/local/sbin/update-grub-no-rootflags"
    btrfs_snapshot_markers: "snapshot|\\.snapshots|@/\\.snapshots|grub-btrfs"

    # Internal variables
    snapper_timers:
      - snapper-cleanup.timer
      - snapper-backup.timer
      - snapper-timeline.timer

  block:
    - name: Check if any supported bootloader is detected
      ansible.builtin.set_fact:
        btrfs_has_supported_bootloader: >-
          {{ (is_grub_boot | default(false)) or
             (is_limine_boot | default(false)) or
             (is_systemd_boot | default(false)) or
             (is_refind_boot | default(false)) }}

    - name: Warn if no supported bootloader detected
      ansible.builtin.debug:
        msg: "WARNING: No supported bootloader detected (GRUB, systemd-boot, rEFInd, or Limine). Some btrfs snapshot rollback functionality may be limited."
      when: not (btrfs_has_supported_bootloader | default(false))

    - name: Include system detection tasks
      ansible.builtin.include_tasks: detection.yml
      tags: [extra, btrfs, btrfs_detection]

    - name: Create and mount BTRFS root volume
      block:
        - name: Create BTRFS mount directory
          ansible.builtin.file:
            path: "{{ btrfs_mount }}"
            state: directory
            mode: "0755"

        - name: Ensure BTRFS root subvolume is unmounted
          ansible.posix.mount:
            path: "{{ btrfs_mount }}"
            state: absent
          register: btrfs_unmounted
          ignore_errors: true

        - name: Mount BTRFS root volume
          ansible.posix.mount:
            path: "{{ btrfs_mount }}"
            src: "{{ btrfs_root_fs_dev }}"
            fstype: btrfs
            opts: "subvolid=5,noatime"
            state: mounted
          register: btrfs_mounted

    - name: Include snapper installation tasks
      ansible.builtin.include_tasks: packages.yml
      when: ansible_facts['distribution'] == "Archlinux"
      tags: [extra, btrfs, btrfs_packages]

    - name: Include GRUB configuration tasks for snapper rollback support
      ansible.builtin.include_tasks: grub.yml
      tags: [extra, btrfs, btrfs_grub]

    - name: Include Limine configuration tasks for snapper rollback support
      ansible.builtin.include_tasks: limine.yml
      tags: [extra, btrfs, btrfs_limine]

    - name: Include systemd-boot configuration tasks for snapper rollback support
      ansible.builtin.include_tasks: systemd-boot.yml
      tags: [extra, btrfs, btrfs_systemd_boot]

    - name: Include rEFInd configuration tasks for snapper rollback support
      ansible.builtin.include_tasks: refind.yml
      tags: [extra, btrfs, btrfs_refind]

    - name: Include fstab configuration tasks for snapper rollback support
      ansible.builtin.include_tasks: fstab.yml
      tags: [extra, btrfs, btrfs_fstab]

    - name: Include snapper configuration tasks
      ansible.builtin.include_tasks: snapper.yml
      tags: [extra, btrfs, btrfs_snapper]

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      changed_when: false

    - name: Restart and enable snapperd service
      ansible.builtin.systemd:
        name: snapperd.service
        state: restarted
        enabled: true

    - name: Enable snapper timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
      loop: "{{ snapper_timers }}"

    - name: Trigger GRUB configuration regeneration when using GRUB
      ansible.builtin.debug:
        msg: "Triggering GRUB configuration regeneration"
      when: is_grub_boot | default(false)
      changed_when: false
      notify: Regenerate GRUB configuration

    - name: Trigger systemd-boot configuration regeneration when using systemd-boot
      ansible.builtin.debug:
        msg: "Triggering systemd-boot configuration regeneration"
      when: is_systemd_boot | default(false)
      changed_when: false
      notify: Regenerate systemd-boot configuration

    - name: Trigger rEFInd configuration update when using rEFInd
      ansible.builtin.debug:
        msg: "Triggering rEFInd configuration update"
      when: is_refind_boot | default(false)
      changed_when: false
      notify: Update rEFInd configuration
