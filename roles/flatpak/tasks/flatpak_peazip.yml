---
- name: Handle PeaZip installation
  when: install_peazip | default(false)
  tags: [extra, flatpak, flatpak_extra, flatpak_peazip]
  vars:
    peazip_app: "io.github.peazip.PeaZip"
    pinned_peazip_ver: "04aea5bd3a84ddd5ddb032ef08c2e5214e3cc2448bdce155d446d30a84185278"
  block:
    - name: Install PeaZip
      community.general.flatpak:
        name: "{{ peazip_app }}"
        state: present
        method: user

    - name: Apply PeaZip Dolphin integrations
      block:
        - name: Check for PeaZip-Dolphin fix script
          ansible.builtin.stat:
            path: "{{ dotfiles_root }}/Configs/scripts/fix-peazip-dolphin-integration.sh"
          register: flatpak_peazip_script

        - name: Check if fix marker exists
          ansible.builtin.stat:
            path: "{{ home_realpath }}/.local/share/kio/servicemenus/peazipadd.desktop"
          register: flatpak_peazip_fix_marker

        - name: Apply PeaZip Dolphin integration fix
          when:
            - flatpak_peazip_script.stat.exists
            - not flatpak_peazip_fix_marker.stat.exists
          ansible.builtin.command: "{{ dotfiles_root }}/Configs/scripts/fix-peazip-dolphin-integration.sh"
          register: flatpak_peazip_apply_fix
          changed_when: false

        - name: Verify fix application
          when:
            - not ansible_check_mode
            - not flatpak_peazip_fix_marker.stat.exists
            - flatpak_peazip_apply_fix.rc is defined
            - flatpak_peazip_apply_fix.rc == 0
          ansible.builtin.stat:
            path: "{{ home_realpath }}/.local/share/kio/servicemenus/peazipadd.desktop"
          register: flatpak_peazip_verify_fix
          failed_when: not flatpak_peazip_verify_fix.stat.exists
