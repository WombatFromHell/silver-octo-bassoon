---
- name: Handle Brave browser installation
  when:
    - enable_flatpak
    - install_brave | default(false)
  tags: [extra, flatpak, flatpak_extra, flatpak_brave]
  vars:
    brave_app: com.brave.Browser
  block:
    - name: Install Brave browser
      community.general.flatpak:
        name: "{{ brave_app }}"
        state: present
        method: user

    - name: Install libva-nvidia-driver on Arch
      when:
        - ansible_distribution == "Archlinux"
        - graphics_card == "nvidia"
        - nvidia_missing is not defined
      become: true
      ansible.builtin.package:
        name: "libva-nvidia-driver"
        state: present

    - name: Apply Chromium Nvidia VAAPI fix
      when:
        - graphics_card == "nvidia"
        - nvidia_missing is not defined
      block:
        - name: Check Brave VAAPI fix script
          ansible.builtin.stat:
            path: "{{ dotfiles_root }}/Configs/scripts/fix-vaapi-chromium-flatpak.sh"
          register: brave_script
          ignore_errors: true

        - name: Set executable permission for Brave fix script
          ansible.builtin.file:
            path: "{{ brave_script.stat.path }}"
            mode: "0755"
          when:
            - brave_script.stat.exists is defined
            - brave_script.stat.exists
            - not brave_script.stat.isdir

        - name: Check if Chromium VAAPI fix already applied
          ansible.builtin.stat:
            path: "{{ home_realpath }}/.var/app/{{ brave_app }}/dri/nvidia_drv_video.so"
          register: chromium_vaapi_fix_applied
          ignore_errors: true
          changed_when: false

        - name: Apply Brave VAAPI fix
          when:
            - brave_script.stat.exists is defined
            - brave_script.stat.exists
            - not brave_script.stat.isdir
            - not (chromium_vaapi_fix_applied.stat.exists is defined
              and chromium_vaapi_fix_applied.stat.exists)
          ansible.builtin.script: "{{ brave_script.stat.path }}"
          register: chromium_vaapi_fix
          ignore_errors: true
          changed_when:
            - chromium_vaapi_fix.rc == 0
            - chromium_vaapi_fix_applied is defined
