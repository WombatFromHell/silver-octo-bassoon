- name: Handle Brave browser installation
  when:
    - enable_flatpak
    - install_brave | default(false)
  tags: [extra, flatpak, flatpak_extra, flatpak_brave]
  vars:
    brave_app: com.brave.Browser
  block:
    - name: Install Brave browser
      community.general.flatpak:
        name: "{{ brave_app }}"
        state: present
        method: user

    - name: Install libva-nvidia-driver on Arch
      when:
        - ansible_distribution == "Archlinux"
        - nvidia_exists | default(false)
      become: true
      ansible.builtin.package:
        name: "libva-nvidia-driver"
        state: present

    - name: Install mesa driver on Arch
      when:
        - ansible_distribution == "Archlinux"
        - amd_exists | default(false)
      become: true
      ansible.builtin.package:
        name: "mesa"
        state: present

    - name: Apply Chromium VAAPI fix
      when:
        - nvidia_exists | default(false)
        - amd_exists | default(false)
      block:
        - name: Check Brave VAAPI fix script
          ansible.builtin.stat:
            path: "{{ dotfiles_root }}/Configs/scripts/fix-vaapi-chromium-flatpak.sh"
          register: brave_script
          ignore_errors: true

        - name: Set executable permission for Brave fix script
          ansible.builtin.file:
            path: "{{ brave_script.stat.path }}"
            mode: "0755"
          when:
            - brave_script.stat.exists is defined
            - brave_script.stat.exists
            - not brave_script.stat.isdir

        - name: Check if VAAPI driver files exist
          ansible.builtin.stat:
            path: "{{ home_realpath }}/.var/app/{{ brave_app }}/dri/{{ item }}"
          register: vaapi_fix_check
          ignore_errors: true
          changed_when: false
          loop:
            - "nvidia_drv_video.so"
            - "radeonsi_drv_video.so"

        - name: Assert at least one VAAPI driver file exists
          ansible.builtin.assert:
            that:
              - vaapi_fix_check is success
              - vaapi_fix_check.results | selectattr('stat.exists') | list | length > 0
            fail_msg: "No VAAPI driver files found, will attempt to apply fix"
            success_msg: "VAAPI driver files already exist"
          register: vaapi_check
          ignore_errors: true

        - name: Apply Brave VAAPI fix
          when:
            - brave_script.stat.exists is defined
            - brave_script.stat.exists
            - not brave_script.stat.isdir
            - vaapi_check is failed # Only run if the assert failed (no drivers found)
          ansible.builtin.script: "{{ brave_script.stat.path }}"
          register: chromium_vaapi_fix
          ignore_errors: true
          changed_when: chromium_vaapi_fix.rc == 0
