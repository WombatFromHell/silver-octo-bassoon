---
- name: Install discord-flatpak-rpc-bridge
  when: install_arpc_fix | default(false)
  tags: [extra, arpc]
  block:
    - name: Ensure installer script exists
      ansible.builtin.stat:
        path: "{{ role_path }}/files/discord-flatpak-rpc-bridge/install.sh"
      register: arpcbridge_installer
      failed_when: not arpcbridge_installer.stat.exists

    - name: Check if system-wide unit files exist
      ansible.builtin.stat:
        path: "/etc/systemd/user/discord-flatpak-rpc-bridge.{{ item }}"
      loop:
        - service
        - socket
      register: arpcbridge_system_units

    - name: Run system-wide install (if unit files missing)
      ansible.builtin.command: ./install.sh -i
      args:
        chdir: "{{ role_path }}/files/discord-flatpak-rpc-bridge"
      when: arpcbridge_system_units.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      become: true
      changed_when: true

    - name: Get current socket status
      ansible.builtin.systemd:
        name: discord-flatpak-rpc-bridge.socket
        scope: user
      register: arpcbridge_socket_status
      failed_when: false
      changed_when: false

    - name: Run user-specific enable (if socket not enabled/active)
      ansible.builtin.command: ./install.sh -e
      args:
        chdir: "{{ role_path }}/files/discord-flatpak-rpc-bridge"
      when: >-
        arpcbridge_socket_status.status is not defined or
        arpcbridge_socket_status.status.UnitFileState | default('') != 'enabled' or
        arpcbridge_socket_status.status.ActiveState | default('') not in ['active', 'activating']
      changed_when: true
