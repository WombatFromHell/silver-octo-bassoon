---
- name: AppImages processing
  tags: [extra, appimages]
  when: enable_appimages | default(false)
  block:
    - name: Ensure required directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ home_dir }}/AppImages"
        - "{{ home_dir }}/.local/bin"
        - "/usr/local/bin"

    - name: Find xdg-open location
      ansible.builtin.command: which xdg-open
      register: base_xdg_open_initial
      changed_when: false
      failed_when: base_xdg_open_initial.rc != 0

    - name: Resolve xdg-open symlink
      ansible.builtin.command: readlink -f "{{ base_xdg_open_initial.stdout }}"
      register: base_xdg_open_path
      changed_when: false
      failed_when: base_xdg_open_path.rc != 0

    - name: Check if /usr/local/bin/xdg-open is a symlink
      ansible.builtin.stat:
        path: /usr/local/bin/xdg-open
      register: base_xdg_symlink_stat

    - name: Create symlink if it does not exist or is incorrect
      become: true
      ansible.builtin.file:
        src: "{{ base_xdg_open_path.stdout }}"
        dest: /usr/local/bin/xdg-open
        state: link
        force: true
      when: >
        not (base_xdg_symlink_stat.stat.exists | default(false)) or
        not (base_xdg_symlink_stat.stat.islnk | default(false)) or
        (base_xdg_symlink_stat.stat.lnk_target | default('') != base_xdg_open_path.stdout)
      register: base_xdg_open_symlink

    - name: Verify that the xdg-open symlink was created
      ansible.builtin.assert:
        that:
          - base_xdg_open_symlink.changed or (base_xdg_symlink_stat.stat.exists and base_xdg_symlink_stat.stat.islnk and base_xdg_symlink_stat.stat.lnk_target
            == base_xdg_open_path.stdout)
        fail_msg: "The xdg-open symlink was not created correctly"
      when: base_xdg_open_symlink.changed or base_xdg_symlink_stat.stat.exists

    - name: Install fuse2 on Archlinux (required for AppImage execution)
      become: true
      ansible.builtin.package:
        name: "fuse2"
        state: present
      when: ansible_facts['distribution'] == "Archlinux"

    - name: Find all AppImages in source directory
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/files/support/appimages"
        patterns: "*.AppImage"
        file_type: file
      register: base_appimages_to_copy
      ignore_errors: true # Continue even if directory doesn't exist

    - name: Check for existing lowercase appimage files
      ansible.builtin.find:
        paths: "{{ home_dir }}/AppImages"
        patterns: "*.appimage"
        file_type: file
      register: base_existing_lowercase_appimages
      ignore_errors: true

    - name: Process found AppImages
      when: base_appimages_to_copy.matched > 0
      block:
        - name: Create list of lowercase filenames that already exist
          ansible.builtin.set_fact:
            base_existing_lowercase_filenames: >-
              {{
                base_existing_lowercase_appimages.files
                | map(attribute='path')
                | map('basename')
                | map('regex_replace', '\\.appimage$', '')
                | list
              }}

        - name: Extract basenames from AppImages to copy
          ansible.builtin.set_fact:
            base_source_appimage_paths: "{{ base_appimages_to_copy.files | map(attribute='path') | list }}"
            base_source_appimage_basenames: "{{ base_appimages_to_copy.files | map(attribute='path') | map('basename') | list }}"

        - name: Create list of AppImage basenames without extension
          ansible.builtin.set_fact:
            base_source_appimage_names: "{{ base_source_appimage_basenames | map('regex_replace', '\\.AppImage$', '') | list }}"

        - name: Filter AppImages to copy (skip those with lowercase versions)
          ansible.builtin.set_fact:
            base_final_appimages: "{{ [] }}"

        - name: Build final AppImages list
          ansible.builtin.set_fact:
            base_final_appimages: "{{ base_final_appimages + [base_source_appimage_paths[idx]] }}"
          loop: "{{ base_source_appimage_names }}"
          loop_control:
            index_var: idx
          when: >
            (base_source_appimage_names[idx] not in base_existing_lowercase_filenames) or
            (base_source_appimage_names[idx] == 'ghostty' and 'ghostty' not in base_existing_lowercase_filenames)

        - name: Copy AppImages with proper permissions
          ansible.builtin.copy:
            src: "{{ item }}"
            dest: "{{ home_dir }}/AppImages/{{ item | basename }}"
            remote_src: false
            mode: "0755"
          loop: "{{ base_final_appimages | default([]) }}"
          loop_control:
            label: "{{ item | basename }}"
          when: base_final_appimages | default([]) | length > 0
          failed_when: false # Continue on individual copy failures

    - name: Process exports (icons/desktop) for AppImages
      when: base_appimages_to_copy.matched > 0
      block:
        - name: Ensure 'applications' directory exists
          ansible.builtin.file:
            path: "{{ home_realpath }}/.local/share/applications"
            state: directory
            mode: "0755"
            force: true

        - name: Ensure 'exported' directory exists
          ansible.builtin.stat:
            path: "{{ role_path }}/files/exported"
          register: base_stat_exported

        - name: Find all '.desktop' files in exported dir
          when: base_stat_exported.stat is defined and base_stat_exported.stat.exists
          ansible.builtin.find:
            paths: "{{ role_path }}/files/exported"
            patterns: "*.desktop.j2"
          register: base_desktop_files

        - name: Check if update-desktop-database exists
          ansible.builtin.command: which update-desktop-database
          register: base_desktop_db_check
          changed_when: false
          ignore_errors: true

        - name: Install '.desktop' files
          ansible.builtin.template:
            src: "{{ item.path }}"
            dest: "{{ home_realpath }}/.local/share/applications/{{ item.path | basename | regex_replace('\\.j2$', '') }}"
            mode: "0644"
            force: true
          loop: "{{ base_desktop_files.files }}"
          loop_control:
            label: "{{ item.path | basename }}"
          notify: update_desktop_database

        - name: Ensure '.desktop' files installed exist
          ansible.builtin.stat:
            path: "{{ home_realpath }}/.local/share/applications/{{ item.path | basename }}"
          loop: "{{ base_desktop_files.files }}"
          loop_control:
            label: "{{ item.path | basename }}"

        - name: Ensure '.icons' source directory exists
          ansible.builtin.file:
            path: "{{ playbook_dir }}/files/support/appimages/.icons"
            state: directory
            mode: "0755"
            force: true
          register: base_icons_source

        - name: Ensure '.icons' target directory exists
          ansible.builtin.file:
            path: "{{ home_realpath }}/AppImages/.icons"
            state: directory
            mode: "0755"
            force: true
          register: base_icons_target

        - name: Find all '.icons' files in
          when:
            - base_icons_source.state == "directory"
            - base_stat_exported.stat is defined and base_stat_exported.stat.exists
          ansible.builtin.find:
            paths: "{{ base_icons_source.path }}"
            patterns: "*.png"
          register: base_icon_files

        - name: Install '.icons' files
          when:
            - base_icons_target.state == "directory"
            - base_icon_files.files is defined and base_icon_files.files | length > 0
          ansible.builtin.copy:
            src: "{{ item.path }}"
            dest: "{{ home_realpath }}/AppImages/.icons/{{ item.path | basename }}"
            mode: "0644"
            force: true
            checksum: false
          loop: "{{ base_icon_files.files }}"
          loop_control:
            label: "Copying {{ item.path }}"

        - name: Ensure '.icons' files installed exist
          ansible.builtin.stat:
            path: "{{ home_realpath }}/AppImages/.icons/{{ item.path | basename }}"
          loop: "{{ base_icon_files.files }}"
          loop_control:
            label: "{{ item.path | basename }}"

    - name: Process Alacritty
      when: >
        enable_alacritty | default(false) and
        base_appimages_to_copy.matched > 0 and
        ('alacritty.AppImage' in (base_appimages_to_copy.files | map(attribute='path') | map('basename') | list))
      block:
        - name: Check for existing Ghostty installations
          ansible.builtin.stat:
            path: "{{ home_dir }}/AppImages/alacritty.{{ item }}"
          loop:
            - "AppImage"
            - "appimage"
          loop_control:
            label: "alacritty.{{ item }}"
          register: base_alacritty_check
          changed_when: false

        - name: Rename Alacritty to lowercase if needed
          ansible.builtin.command:
            cmd: mv "{{ home_dir }}/AppImages/alacritty.AppImage" "{{ home_dir }}/AppImages/alacritty.appimage"
          args:
            creates: "{{ home_dir }}/AppImages/alacritty.appimage"
          when:
            - base_alacritty_check.results[0].stat.exists | default(false)
            - not base_alacritty_check.results[1].stat.exists | default(false)
          register: base_alacritty_moved

        - name: Create symlink for Alacritty
          ansible.builtin.file:
            src: "{{ home_dir }}/AppImages/alacritty.appimage"
            dest: "{{ home_dir }}/.local/bin/alacritty"
            state: link
            force: true
          when: >
            (base_alacritty_check.results[1].stat.exists | default(false)) or
            (base_alacritty_moved is defined and base_alacritty_moved.changed | default(false))

    - name: Process Ghostty
      when: >
        enable_ghostty | default(false) and
        base_appimages_to_copy.matched > 0 and
        ('ghostty.AppImage' in (base_appimages_to_copy.files | map(attribute='path') | map('basename') | list))
      block:
        - name: Check for existing Ghostty installations
          ansible.builtin.stat:
            path: "{{ home_dir }}/AppImages/ghostty.{{ item }}"
          loop:
            - "AppImage"
            - "appimage"
          loop_control:
            label: "ghostty.{{ item }}"
          register: base_ghostty_check
          changed_when: false

        - name: Rename Ghostty to lowercase if needed
          ansible.builtin.command:
            cmd: mv "{{ home_dir }}/AppImages/ghostty.AppImage" "{{ home_dir }}/AppImages/ghostty.appimage"
          args:
            creates: "{{ home_dir }}/AppImages/ghostty.appimage"
          when:
            - base_ghostty_check.results[0].stat.exists | default(false)
            - not base_ghostty_check.results[1].stat.exists | default(false)
          register: base_ghostty_moved

        - name: Create symlink for Ghostty
          ansible.builtin.file:
            src: "{{ home_dir }}/AppImages/ghostty.appimage"
            dest: "{{ home_dir }}/.local/bin/ghostty"
            state: link
            force: true
          when: >
            (base_ghostty_check.results[1].stat.exists | default(false)) or
            (base_ghostty_moved is defined and base_ghostty_moved.changed | default(false))
