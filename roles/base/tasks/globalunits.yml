---
- name: Copy and enable systemd units to /etc/systemd/system
  tags: [extra, globalunits]
  become: true
  block:
    - name: Ensure /etc/systemd/system directory exists
      ansible.builtin.file:
        path: /etc/systemd/system
        state: directory
        mode: "0755"

    - name: Find all unit files, filtering out unnecessary ones if NVIDIA driver is missing
      ansible.builtin.find:
        paths: "{{ role_path }}/files/units"
        file_type: file
        recurse: false
        excludes: "{{ ['nvidia-tdp.*', 'veridian-controller.service'] if not nvidia_exists | default(false) else [] }}"
      register: base_unit_files

    - name: Copy unit files to /etc/systemd/system with proper permissions
      ansible.builtin.copy:
        src: "{{ file_item.path }}"
        dest: "/etc/systemd/system/{{ file_item.path | basename }}"
        mode: "0644"
        remote_src: false
        backup: true
      loop: "{{ base_unit_files.files }}"
      loop_control:
        loop_var: file_item
        label: "Copying {{ file_item.path | basename }}"
      when: base_unit_files.matched > 0
      notify: reload_global_systemd

    # - name: Enable service units
    #   when: not ansible_check_mode
    #   ansible.builtin.systemd:
    #     name: "{{ unit_file.path | basename }}"
    #     daemon_reload: true
    #     enabled: true
    #     state: started
    #   loop: "{{ base_unit_files.files }}"
    #   loop_control:
    #     loop_var: unit_file
    #     label: "Enabling {{ unit_file.path | basename }}"
    #   check_mode: false

    - name: Check if scx_loader.service exists
      become: true
      ansible.builtin.stat:
        path: "{{ item }}"
      register: base_scx_service_stat
      changed_when: false
      loop:
        - /etc/systemd/system/scx_loader.service
        - /usr/lib/systemd/system/scx_loader.service
        - /lib/systemd/system/scx_loader.service

    - name: Set fact if service exists
      ansible.builtin.set_fact:
        base_scx_service_exists: "{{ base_scx_service_stat.results | selectattr('stat.exists') | list | length > 0 }}"
      when: base_scx_service_stat.results is defined

    - name: Configure scx_loader if service exists
      when: base_scx_service_exists | default(false)
      block:
        - name: Check if scx_loader.toml already exists
          ansible.builtin.stat:
            path: /etc/scx_loader.toml
          register: base_existing_scx_toml
          changed_when: false

        - name: Backup existing scx_loader.toml if it exists
          become: true
          ansible.builtin.copy:
            src: /etc/scx_loader.toml
            dest: /etc/scx_loader.toml.bak
            remote_src: true
            mode: "0644"
            owner: root
            group: root
            force: true
          when:
            - base_existing_scx_toml.stat.exists

        - name: Copy scx_loader.toml configuration
          become: true
          ansible.builtin.copy:
            src: "{{ role_path }}/files/etc/scx_loader.toml"
            dest: /etc/scx_loader.toml
            mode: "0644"
            owner: root
            group: root
          notify: enable_scx_loader
