---
- name: Per-host roles
  hosts:
    - methyl-cachyos
    - methyl-bazzite
  vars:
    home_realpath: "{{ ansible_env.HOME | realpath }}"

  pre_tasks:
    - name: Gather NVIDIA driver facts
      block:
        - name: Check for NVIDIA driver presence
          ansible.builtin.stat:
            path: /proc/driver/nvidia
          register: nvidia_driver
          when: graphics_card is defined and graphics_card == "nvidia"

        - name: Determine if NVIDIA driver is missing
          ansible.builtin.set_fact:
            nvidia_missing: >-
              {{
                (graphics_card is not defined) or
                (graphics_card != "nvidia") or
                (graphics_card == "nvidia" and
                (nvidia_driver is not defined or not nvidia_driver.stat.exists))
              }}
            cacheable: true

    - name: Gather GRUB bootloader facts
      become: true
      block:
        - name: Check for GRUB bootloader
          ansible.builtin.stat:
            path: /boot/efi/EFI/boot/bootx64.efi
          register: grub_check
          check_mode: false

        - name: Set bootloader facts
          ansible.builtin.set_fact:
            is_grub_boot: "{{ grub_check.stat.exists | default(false) }}"
          check_mode: false

  roles:
    - btrfs
    - base
    - dotfiles
    - mounts
    - flatpak
    - distrobox
    - vfio
    - arpcbridge
